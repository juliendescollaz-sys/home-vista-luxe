; =============================================================================
; Dialplan Neolia Gateway
; =============================================================================
; Routage des appels depuis l'Akuvox vers les panels
; =============================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; Mapping Akuvox button -> Panel extension
; Format: PANEL_{button_code}=extension
; Le bouton 401 sur l'Akuvox appelle le panel-401
PANEL_401=panel-401
PANEL_402=panel-402
PANEL_403=panel-403

; Timeout sonnerie (secondes)
RING_TIMEOUT=60

; =============================================================================
; CONTEXTE: Appels depuis l'Akuvox
; =============================================================================
[from-akuvox]

; L'Akuvox appelle avec le numero d'appartement (ex: 401)
; On route vers le panel correspondant
exten => _4XX,1,NoOp(Appel Akuvox vers appartement ${EXTEN})
 same => n,Set(PANEL_EXT=${GLOBAL(PANEL_${EXTEN})})
 same => n,GotoIf($["${PANEL_EXT}" = ""]?no-panel,1)
 same => n,NoOp(Routage vers ${PANEL_EXT})
 same => n,Dial(PJSIP/${PANEL_EXT},${RING_TIMEOUT},t)
 same => n,Goto(no-answer,1)

; Pas de panel configure pour cet appartement
exten => no-panel,1,NoOp(Aucun panel configure pour ${EXTEN})
 same => n,Playback(ss-noservice)
 same => n,Hangup()

; Pas de reponse
exten => no-answer,1,NoOp(Pas de reponse du panel)
 same => n,Hangup()

; Extension speciale: test (appelle tous les panels)
exten => 999,1,NoOp(Test broadcast vers tous les panels)
 same => n,Dial(PJSIP/panel-401&PJSIP/panel-402&PJSIP/panel-403,${RING_TIMEOUT},t)
 same => n,Hangup()

; Appel direct vers une extension (format: 1XXX)
exten => _1XXX,1,NoOp(Appel direct vers ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},${RING_TIMEOUT},t)
 same => n,Hangup()

; =============================================================================
; CONTEXTE: Appels depuis un Panel
; =============================================================================
[from-panel]

; Panel peut appeler l'Akuvox (extension 100) pour ouvrir la porte par DTMF
exten => 100,1,NoOp(Panel appelle Akuvox)
 same => n,Dial(PJSIP/akuvox,30,t)
 same => n,Hangup()

; Panel peut appeler un autre panel (debug/test)
exten => _panel-4XX,1,NoOp(Inter-panel call to ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},60,t)
 same => n,Hangup()

; Extension echo test
exten => *43,1,Answer()
 same => n,Echo()
 same => n,Hangup()

; Extension info
exten => *65,1,Answer()
 same => n,SayDigits(${CALLERID(num)})
 same => n,Hangup()

; =============================================================================
; CONTEXTE: Catch-all pour extensions inconnues
; =============================================================================
[default]
exten => _X.,1,NoOp(Extension inconnue: ${EXTEN})
 same => n,Playback(ss-noservice)
 same => n,Hangup()

exten => i,1,NoOp(Invalid extension)
 same => n,Hangup()

exten => h,1,NoOp(Hangup handler)
