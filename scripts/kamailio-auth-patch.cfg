# =========================================================
# PATCH pour ajouter l'authentification a Kamailio
# A appliquer sur /etc/kamailio/kamailio.cfg
# =========================================================

# 1. AJOUTER ces defines en haut du fichier (apres #!define WITH_RTPENGINE)
#!define WITH_AUTH
#!define WITH_MYSQL
#!define DBURL "mysql://kamailio:Kampass2024!@localhost/kamailio"

# 2. AJOUTER ces modules dans la section "Modules Section" (apres loadmodule "sdpops.so")
#!ifdef WITH_MYSQL
loadmodule "db_mysql.so"
#!endif

#!ifdef WITH_AUTH
loadmodule "auth.so"
loadmodule "auth_db.so"
#!endif

# 3. AJOUTER ces parametres dans la section "module-specific parameters"
#!ifdef WITH_AUTH
# ----- auth_db params -----
modparam("auth_db", "db_url", DBURL)
modparam("auth_db", "calculate_ha1", yes)
modparam("auth_db", "password_column", "password")
modparam("auth_db", "load_credentials", "")
modparam("auth_db", "use_domain", 0)
#!endif

# 4. MODIFIER la route[REGISTRAR] pour ajouter l'authentification
# Remplacer:
#   route[REGISTRAR] {
#     if (!is_method("REGISTER")) return;
#     if(isflagset(FLT_NATS)) {
#       setbflag(FLB_NATB);
#     }
#     if (!save("location")) {
#       sl_reply_error();
#     }
#     exit;
#   }
#
# Par:
route[REGISTRAR] {
    if (!is_method("REGISTER")) return;

#!ifdef WITH_AUTH
    # Authentification requise pour REGISTER
    if (!www_authenticate("sip.neolia.app", "subscriber")) {
        www_challenge("sip.neolia.app", "0");
        exit;
    }

    # Verifier que l'utilisateur s'enregistre avec son propre username
    if ($au != $tU) {
        sl_send_reply("403", "Forbidden - use your own username");
        exit;
    }
#!endif

    if(isflagset(FLT_NATS)) {
        setbflag(FLB_NATB);
    }

    if (!save("location")) {
        sl_reply_error();
    }
    exit;
}

# 5. AJOUTER une route AUTH pour les INVITEs (optionnel mais recommande)
# Ajouter dans request_route, apres route(REGISTRAR):
#
#   # Authentifier les appels sortants
#   if (is_method("INVITE") && from_uri==myself) {
#       if (!proxy_authorize("sip.neolia.app", "subscriber")) {
#           proxy_challenge("sip.neolia.app", "0");
#           exit;
#       }
#       consume_credentials();
#   }

# =========================================================
# CREATION DE LA TABLE SUBSCRIBER
# =========================================================
# Executer ces commandes SQL sur le serveur:
#
# mysql -u root -p
# USE kamailio;
#
# CREATE TABLE IF NOT EXISTS subscriber (
#     id INT(10) UNSIGNED AUTO_INCREMENT PRIMARY KEY NOT NULL,
#     username VARCHAR(64) NOT NULL DEFAULT '',
#     domain VARCHAR(64) NOT NULL DEFAULT '',
#     password VARCHAR(64) NOT NULL DEFAULT '',
#     email_address VARCHAR(64) NOT NULL DEFAULT '',
#     ha1 VARCHAR(64) NOT NULL DEFAULT '',
#     ha1b VARCHAR(64) NOT NULL DEFAULT '',
#     rpid VARCHAR(64) DEFAULT NULL,
#     INDEX account_idx (username, domain)
# ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
#
# -- Creer un utilisateur de test
# -- Le password 'test123' donne HA1 = MD5('testuser:sip.neolia.app:test123')
# INSERT INTO subscriber (username, domain, password, ha1) VALUES
#     ('testuser', 'sip.neolia.app', 'test123', MD5('testuser:sip.neolia.app:test123'));
#
# =========================================================

# Pour appliquer les changements:
# 1. Sauvegarder l'ancien fichier: sudo cp /etc/kamailio/kamailio.cfg /etc/kamailio/kamailio.cfg.bak
# 2. Editer le fichier: sudo nano /etc/kamailio/kamailio.cfg
# 3. Verifier la syntaxe: kamailio -c
# 4. Redemarrer: sudo systemctl restart kamailio
# 5. Verifier les logs: sudo journalctl -u kamailio -f
